---
bibliography: papers.bib
---

```{r}
#| include: false

library(here)
library(DiagrammeR)

```

# Estimation of effects using causal mediation analysis
<!-- Daniel 120 min -->

## Recap from yesterday

- causal inference in general
- causal mediation analysis
  - the controlled direct effect (CDE)
  - natural direct effect (NDE)
  - natural indirect effect (NIE)

```{r, engine="tikz", fig.cap = "Fig. 3. DAG under *no intermediate confounders* of the mediator-outcome relation affected by treatment", fig.ext=if (knitr:::is_latex_output()) "pdf" else "png", echo = FALSE}
\dimendef\prevdepth=0
\pgfdeclarelayer{background}
\pgfsetlayers{background,main}
\usetikzlibrary{arrows,positioning}
\tikzset{
>=stealth',
punkt/.style={
rectangle,
rounded corners,
draw=black, very thick,
text width=6.5em,
minimum height=2em,
text centered},
pil/.style={
->,
thick,
shorten <=2pt,
shorten >=2pt,}
}
\newcommand{\Vertex}[2]
{\node[minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};
}
\newcommand{\VertexR}[2]
{\node[rectangle, draw, minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};
}
\newcommand{\ArrowR}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) to[bend right=30] (#2);
\end{pgfonlayer}
}
\newcommand{\ArrowL}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) to[bend left=45] (#2);
\end{pgfonlayer}
}
\newcommand{\EdgeL}[3]
{ \begin{pgfonlayer}{background}
\draw[dashed,#3] (#1) to[bend right=-45] (#2);
\end{pgfonlayer}
}
\newcommand{\Arrow}[3]
{ \begin{pgfonlayer}{background}
\draw[->,#3] (#1) -- +(#2);
\end{pgfonlayer}
}
\begin{tikzpicture}
  \Vertex{-4, 0}{W}
  \Vertex{0, 0}{M}
  \Vertex{-2, 0}{A}
  \Vertex{2, 0}{Y}
  \Arrow{W}{A}{black}
  \Arrow{A}{M}{black}
  \Arrow{M}{Y}{black}
  \ArrowL{W}{Y}{black}
  \ArrowL{A}{Y}{black}
  \ArrowL{W}{M}{black}
\end{tikzpicture}
```

## Regression-based approach
General problems with the traditional approach is when we have exposure-mediator interaction and non-linear relationships. 

Counterfactual-based direct and indirect effects can be estimated, provided that the no-confounding assumption hold.

Model for the mediator:
$E(M|A = a, W = w) = \beta_0 + \beta_1a + \beta'_2w $

Model for the outcome:
$E(Y|A = a, M = m, W = w) = \sigma_0 + \sigma_1a + \sigma_2m + \sigma_3am + \sigma'_4w $

From these two regression models we can estimate the CDE, NDE and NIE.

Let's use models to estimate this. We will investigate...

We load the dataset.
<!-- use our own data example when this is ready -->

```{r}

n <- 1e6
w <- rnorm(n)
a <- rnorm(n)*3+5
m <- rnorm(n, w + a)
y <- rnorm(n, w + a + m)
```

We can now run a model for the mediator

```{r}
lm_m <- lm(m ~ a + w)

summary(lm_m)
```
And run the model for the outcome

```{r}
lm_y <- lm(y ~ a + m + a:m + w)

summary(lm_y)
```

### Controlled direct effect

The controlled direct effect can be obtained using this formula based on the regression coefficients:

$CDE(m) = (\sigma_1 + \sigma_3*m)(a - a^*) $

$a^*$ is for a change from level $a^*$ to level $a$.

For the controlled direct effect we set m to a specific value. In this example we will set it to 5.

```{r}

CDE_m <- (lm_y$coefficients[1] + lm_y$coefficients[5]*5)*(7 - 5) 

as.numeric(CDE_m)
```
The CDE here is how much the outcome would change on average if the mediator were fixed at level m=5 uniformly in the population but the treatment were changed from 5 to 7. 

### Natural direct effect

NDE can be obtained using this formula: 

$NDE = (\sigma_1 + \sigma_3*\beta_1*a^* + \sigma_3*\beta'_2w)(a - a^*) $

We set the value for the confounder w for the interaction to be the mean value (=0.000126). 

```{r}

NDE <- (lm_y$coefficients[1] + lm_y$coefficients[5]*lm_m$coefficients[2]*7 + lm_y$coefficients[5]*lm_m$coefficients[3]*0.000126)*(7 - 5) 

as.numeric(NDE)
```
The NDE is how much the outcome would change if the treatment a was set at 7 versus 5 but for each individual the mediator was kept at the level it would have taken, for that individual, in the absence of the exposure.

### Natural indirect effect

NIE can be obtained by this formula:

$NDE = (\sigma_2 * \beta_1 + \sigma_3*\beta_1*a)(a - a^*) $

```{r}

NIE <- (lm_y$coefficients[3] * lm_m$coefficients[2] + lm_y$coefficients[5]*lm_m$coefficients[2]*7)*(7 - 5) 

as.numeric(NIE)
```
The NIE is how much the outcome would change on average if the treatment were fixed at level a = 7 but the mediator were changed from the level it would take if a* = 5 to the level it would take if a = 7.

Note that exposure has to have an effect on M otherwise this will be zero.

### 2-way decomposition of effects

The total effect can be decomposed as:

$TE = NDE + NIE $

```{r}
TE <- NDE + NIE

as.numeric(TE)
```
### Proportion eliminated

From this, we can calculate the proportion mediated. 

$PM = \frac{NIE}{TE} $

```{r}
PM <- NIE / TE

as.numeric(PM) * 100
```
99.6% of the association is mediated by m.

### R package example for causal mediation analysis - Mediation-package

We can also use an R package to estimate these values. One package is the 'Mediation' R package.


```{r}
library(mediation)

#some procedures in the packages require simulations
set.seed(2024)

#put our variables in a dataframe - will change once we have the dataset
df <- data.frame(a, m, y, w)

```

First we need to make our models. One for the mediator, one for the outcome.

```{r}
med_fit <- lm(m ~ a + w, data = df)
out_fit <- lm(y ~ a*m + w, data = df)

```

Then, we can make the estimation.

```{r}
med_out <- mediate(model.m = med_fit,
                   model.y = out_fit,
                   treat = "a",
                   mediator = "m",
                   control.value = 5,
                   treat.value = 7,
                   robustSE = TRUE,
                   sims = 10)

summary(med_out)
```
Treatment mediator interaction can be tested:

```{r}
test.TMint(med_out, conf.level = .95)
```

## G-computation-based approach
###############################################################
Under the above mentioned assumptions, we can calculate the estimate using the G-computation.
We will visit a research question in the Framgingham dataset. 

> Does obesity lead to higher CVD risk by increasing higher blood pressure?

(insert figure)

To make my life easier, I will call the exposure (obesity) A, mediator (systolic blood pressure) M, outcome (CVD) Y, A, M, and Y are all binary variables. In addition, I will add two confouding factors in the model (W1: sex, W2: current smoking status (cursmoke)). 

```{r}
full_data <- full_data  %>%
  mutate(A=obesity, M=high_sysbp, Y=cvd, W1=sex, W2=cursmoke)
```
We we want to estimate is: E(Y|A = 0/1, M = 0/1, W1 = W1i, W2 = W2i)

First, we fit outcome regression (include interaction because we can)
```{r}
or_fit <- glm(Y ~ A + M + W1 + W2 + A*M + M*W1 + age,
              family = binomial(), data = full_data)
summary(or_fit)
```

Based on the outcome regression model, we can predict Y under different scenarios. 

```{r}
get_EY_a_m_Wi <- function(full_data, or_fit, a, m){
  data_Aa_Mm_Wi <- full_data
  data_Aa_Mm_Wi$A <- a; data_Aa_Mm_Wi$M <- m
  predict(or_fit, newdata = data_Aa_Mm_Wi, type = "response")
}
## run prediction, for different scenarios (a=1 or 0, and m=1 or 0)
EY_A0_M0_Wi <- get_EY_a_m_Wi(full_data, or_fit, a = 0, m = 0)
EY_A0_M1_Wi <- get_EY_a_m_Wi(full_data, or_fit, a = 0, m = 1)
EY_A1_M0_Wi <- get_EY_a_m_Wi(full_data, or_fit, a = 1, m = 0)
EY_A1_M1_Wi <- get_EY_a_m_Wi(full_data, or_fit, a = 1, m = 1)
```

Next, we will run the mediation models, based on the values of A, and run the prediction models of M. 
```{r}
med_fit <- glm(M ~ A*W1 + W1*W2, family = binomial(), data = full_data)
# estimates of P(M = m | A = a, W = W_i), predict m based on a
get_Pm_a_Wi <- function(full_data, med_fit, a, m){
  data_Aa_Wi <- full_data; data_Aa_Wi$A <- a
  p <- predict(med_fit, newdata = data_Aa_Wi, type = "response")
  if(m == 1){
    p
  }else{
    1 - p
  }
}
##similary, we get the predicted values of m for different scenarios
PM0_A0_Wi <- get_Pm_a_Wi(full_data, med_fit, a = 0, m = 0)
PM1_A0_Wi <- get_Pm_a_Wi(full_data, med_fit, a = 0, m = 1)
PM0_A1_Wi <- get_Pm_a_Wi(full_data, med_fit, a = 1, m = 0)
PM1_A1_Wi <- get_Pm_a_Wi(full_data, med_fit, a = 1, m = 1)
```

Finally, we calculate the predicted Y on the estimates: 
```{r}
# E(E(Y | A = 1, M, W) | A = 1, W)
EY1M1_Wi <- EY_A1_M1_Wi * PM1_A1_Wi + EY_A1_M0_Wi * PM0_A1_Wi
# E(E(Y | A = 0, M, W) | A = 1, W)
EY0M1_Wi <- EY_A0_M1_Wi * PM1_A1_Wi + EY_A0_M0_Wi * PM0_A1_Wi
# E(E(Y | A = 1, M, W) | A = 0, W)
EY1M0_Wi <- EY_A1_M1_Wi * PM1_A0_Wi + EY_A1_M0_Wi * PM0_A0_Wi
# E(E(Y | A = 0, M, W) | A = 0, W)
EY0M0_Wi <- EY_A0_M1_Wi * PM1_A0_Wi + EY_A0_M0_Wi * PM0_A0_Wi
#Finally, we average over distribution of W to get effect esti
# estimate of E[Y(1, M(1))]
E_Y1M1 <- mean(EY1M1_Wi)
# estimate of E[Y(0, M(1))]
E_Y0M1 <- mean(EY0M1_Wi)
# estimate of E[Y(1, M(0))]
E_Y1M0 <- mean(EY1M0_Wi)
# estimate of E[Y(0, M(0))]
E_Y0M0 <- mean(EY0M0_Wi)
```
Now, you can freely calculate the natural direct effect and indirect effect: 

```{r}
E_Y1M1
E_Y1M0
E_Y0M1
E_Y0M0
```

### Controlled direct effect

### Natural direct effect

### Natural indirect effect

## 3-way and 4-way decomposition of effects

### R package example for causal mediation analysis - CMAverse-package

Test of other package

```{r}
library(CMAverse)

res_rb <- cmest(data = df, model = "rb", outcome = "y", exposure = "a",
                            mediator = "m", basec = c("w"), EMint = TRUE,
                            mreg = list("linear"), yreg = "linear",
                            astar = 5, a = 7, mval = list(5), 
                            estimation = "paramfunc", inference = "delta")

summary(res_rb)

```
