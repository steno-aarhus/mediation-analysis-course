# Survival outcomes

<!-- Teaching concepts - Jie (30 min) -->

Coding part - Daniel Teaching concepts - Jie (30 min)

# Time-to-event outcomes

Survival time and mortality are major focus in healthcare research.
There are many studies conducting mediation analyses with time-to-event
outcomes. Survival analysis allows investigators to study these
important outcomes with appropriate consideration for variable follow-up
times, censoring, and competing risks. For example, it was reported that
first and second-generation antipsychotics medication had higher
mortality than placebo in older adults. To disentangle the mechanisms by
which first- and second-generation antipsychotics increase mortality,
Jackson et al. applied causal mediation analysis to quantify the
contribution of various medical events to the mortality who initiate
first- versus second-generation antipsychotics. It was found that 9% of
the mortality difference might be explained by stroke, ventricular
arrhythmia, myocardial infarction, and pneumonia (Jackson). Another
study examined the development in socioeconomic disparity in stroke
progression (e.g., 30-day mortality and 30-day readmission), and the
mediation role of the quality of early stroke care using Danish register
data.

```{r}
# Creating The causal diagram for a mediation model
library(DiagrammeR)
grViz("
digraph {
  graph []
  node [shape = plaintext]
    X [label = 'socioeconomic status']
    M [label = 'quality of stroke care']
    Y [label = 'stroke mortality']
  edge [minlen = 1.5]
    X->Y 
    X->M 
    M->Y 
  { rank = same; X; Y }
  { rank = min; M;}
}")
```

In earlier session,we have been familiar with the counterfactual
concepts in causal mediation: - $Y_i(a, m)$ is the outcome achieved for
person i if, possibly contrary to fact, exposure had been set to a and
mediator to m. - $M_i(a)$ is the mediator achieved for person i if,
possibly contrary to fact, exposure had been set to a.

The counterfactual variable Yi (1, m) corresponds to the death time
observed in a double-intervention randomized trial where early
intervention had been used and secondary medication set to m. Likewise,
the counterfactual variable Mi (1) is the secondary medication observed
in a single-intervention randomized trial where early intervention had
been used. One can combine the two counterfactuals, yielding so-called
nested counterfactuals defined as Y (a, M (a*)). By introducing the
nested counterfactual E\[Y (a, M (a\*))\] for a ≠ a* we can give a
precise mathematical definition of mediation. Once you have grasped the
core builds on comparing distributions of nested counterfactuals, these
effects can just as easily be expressed on other scales than the
averages. For a **survival outcome**, the outcome of interest will be
survival time (SV). - SV (t) = P(V ≥ t) the survival function at time
t - SV (t\|c)=P(V ≥ t\|c) the survival function conditional on
covariates C - λV (t) : the hazard - λV (t\|c) conditional hazard at
time t

If we consider Cox survival model:
$λT (t | a, m, c) = λT (t | 0, 0, 0)eγ1a+γ2m+γ3am+γ$

Then the total effect could be decomposed into direct and indirect
effects on the log-hazard scale as follows:

$log{λTaMa(t|c)}− log{λTaMa∗(t|c)}= (γ2β1 + γ3β1a)(a − a∗)$
$log{λTaMa*(t|c)}− log{λTa*Ma∗(t|c)} = {(γ1+γ3(β0+β1a*+β'2c)γ2σ2)}(a-a*)+0.5γ3σ2(a2-a*2)$

## ESTIMATING NATURAL EFFECTS MODELS

The topic of this section will be the class of natural effect models
(NEMs) originally introduced by Lange et al. \[11\] and Vansterlandt et
al. \[12\] and implemented in the R package medflex \[2\].

The idea underlying NEM is to phrase a mediation analysis as a multiple
regression problem, thereby - a) parameterizing the quantities of
interest, - b) allowing the choice of outcome model to follow the
convention for that type of outcome (i.e., a Cox model for survival
outcomes) -c) harvesting the extensive existing software implementing
regression type models.

In particular, a NEM is a regression model for the nested
counterfactual. Expressed as a generalized linear model (GLM), it
becomes:

$g(E[Y (a, M (a*))]) = α0 + α1a + α2a*$

If, for instance, g is the logit function, then α1 would be the marginal
natural direct effect log-OR.

Estimation algorithms for NEMs are all derived under the assumptions
listed in the preceding section, and build on the trick that first we
duplicate the original data set, then we create an artificial exposure,
A*, which takes on different values in the 2 replications of each
observation. Finally, we use an auxiliary model to link the artificial
observations (i.e., those where A ≠ A*) to the mediators, which is
either done through weighting or through imputation. Once this is done,
the NEM can be estimated by simply applying standard software applied to
the extended data set and using both A and A\*, possibly along with C,
as the model specification. This entire procedure has been automated and
implemented in the R package medflex for any GLM type outcome model. In
the following, we describe in detail how to estimate a NEM for a
survival outcome with a multidimensional mediator. This is the situation
we have in the illustrative case.

Similar as our context, mediation analysis with a time-to-event outcome
have to satisfy below assumptions: -(i) no unmeasured confounding of the
exposure-outcome relation; -(ii) no unmeasured confounding of the
mediator-outcome relation; -(iii) no unmeasured confounding of the
exposure-mediation relation; -(iv) no exposure induced mediation-outcome
confounding

This means that the ratio between and the sum of and represents a
measure of the proportion of the effect of the exposure mediated by the
intermediate on the log-hazard scale. If there is not exposure-mediator
interaction and the outcome is **RARE** (e.g., less than 10% by the end
of follow-up) (ref: VanderWeele_survival), it can be shown that
estimates of direct and indirect effects are equal to the effects we
would have estimated through difference or product method, whose results
coincide in this particular context.

::: callout-note
# Could we use the traditional approach for time-to-event outcomes?

So how to conduct causal mediation analysis for time-to-event outcomes?
We introduced the difference and product methods for continuous and
binary outcomes in previous session, also discuss the caveats of these
approaches. It is still true these methods are ill-adapted to
non-normally distributed continuous and/or censored variables, such as
time-to-event outcomes \[Lois\]. Similar as odds ratio,
''non-collaspsibility'' is a problem of the hazard ratio. (VanderWeele)
Thus, use of Cox PH regression to approximately estimate indirect
effects via difference or product of coefficients rests on the
assumption that the outcome is rare \[21\]. Where the outcome is common,
measures of the indirect effect or proportion mediated will be incorrect
\[arvid\].

To sum up, we could still use these approaches if certain criterias are
fulfilled. Otherwise, we can use the product method to get a sense of
whether there is mediation, but be aware that the estimate is not
accurate.
:::

# Conduct mediation analysis with a time-to-event outcome

## Coding example

::: callout-note
We will continue working on the obesity-CVD example in the Framingham
dataset. The outcome of interest is death from cardiovascular diseases
(cvd). The underlying time scale is in days, starting at participants
entered the cohort. -The exposure of interest is obesity status at
baseline, where a=1 indicates obese, a=0 indicates non-obese. -The
mediator is blood pressure, the counterfactual mediator was M(a), where
M(a) is the mediator when the exposure is obesity (1) and M(0) is the
mediator values when the exposure is not-obese. -The nested
counterfactual was death time. For ease of exposition, we will only
refer to the underlying event time and event indicator when required by
context.
:::

The question of interest here is whether the feeling of loneliness
mediates the impact of hearing loss on time-to-dementia (measured in
years), accounting for mortality as a competing event.

In this example, we will analyze the following variable and the survial
outcome (time).

## Step 1: Fit a parametric survival model with a Weibull error distribution to the survival times including exposure(x), mediator(m) and potentail confounders.

```{r}

```

## Step 2: Create a copy of the original dataset: in the first set copy, the new variable is set to the values of the actual expsoure (A), while in the second copy, the new variable is set to the opposite value of the actual value (A\*).

## Step 3: We now set the temporary exposure variable, used when fitting the imputation model in step 1, to the values in the just created exposure variable (A\*).

## Step 4 and 5: For each draw of the imputed nested counterfactuals, we fit a Cox model including the exposure that was actually received (the coefficient of this variable will estimate the natural indirect log-HR), the created exposure variable (the coefficient of this variable will estimate the natural direct log-HR), and all confounders.

Step 6: Finally, CIs are established by 5,000 bootstrap repetitions of
steps 1-5.

-   survival analysis
-   code-along with package and setup of survival data

# Coding part - Daniel

::: callout-note
## Learning outcomes

-   Perform causal mediation analysis using R software
-   Interpret results from causal mediation analysis
:::

-   survival analysis
-   code-along with package and setup of survival data

<!-- Coding part - Daniel -->

```{r}
library(tidyverse)
framingham <- read.csv(here::here("data", "frmgham2.csv"))

framingham <- framingham %>% select(id = RANDID,
                                    BMI,
                                    m = SYSBP,
                                    y = CVD,
                                    w1 = SEX,
                                    w2 = CURSMOKE,
                                    w3 = AGE,
                                    y_time = TIMECVD) %>% 
  na.omit() %>% 
  mutate(a = case_when(BMI >= 25 ~ 1,
                       TRUE ~ 0),
         y_time = y_time/365.25) %>% 
  select(-BMI)

```

> Does obesity lead to higher CVD risk by increasing blood pressure?

The new thing here is that we need to calculate the time to event. This
is already done in the dataset.

We need the outcome to be the time to event and specify event as the
outcome variable.

```{r}
library(CMAverse)
library(survival)

res_rb_coxph <- cmest(data = framingham, model = "rb", outcome = "y_time", event = "y", exposure = "a",
                            mediator = "m", basec = c("w1", "w2", "w3"), EMint = TRUE,
                            mreg = list("linear"), yreg = "coxph",
                            astar = 0, a = 1, mval = list(120), 
                            estimation = "imputation", inference = "bootstrap")


summary(res_rb_coxph)
```
