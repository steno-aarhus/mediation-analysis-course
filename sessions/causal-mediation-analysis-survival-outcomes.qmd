# Survival outcomes

<!-- Teaching concepts - Jie (30 min) -->

<!-- Daniel will look and trim down a bit - Jie (30 min) -->

Coding part - Daniel Teaching concepts - Jie (30 min)

# Time-to-event outcomes

Survival time and mortality are major focus in healthcare research.
There are many studies conducting mediation analyses with
**time-to-event outcomes**. Survival analysis allows investigators to
study these important outcomes with appropriate consideration for
variable follow-up times, censoring, and competing risks.

For example, a study investigated the effect of socioeconomic status
(SES) on the survival time of cancer patients and how much cancer stage
mediated the effect. They found the effect of SES on survival time was
partially mediated by stage diagnosis (e.g., explaining 12% for lung
cancer)

```{r}
# Creating The causal diagram for a mediation model
library(DiagrammeR)
grViz("
digraph {
  graph []
  node [shape = plaintext]
    X [label = 'socioeconomic status']
    M [label = 'quality of stroke care']
    Y [label = 'stroke mortality']
  edge [minlen = 1.5]
    X->Y
    X->M
    M->Y
  { rank = same; X; Y }
  { rank = min; M;}
}")
```

::: callout-note
In earlier session,we have been familiar with the counterfactual
concepts in causal mediation:

-   $Yi(a, m)$ is the outcome achieved for person i if, possibly
    contrary to fact, exposure had been set to a and mediator to m.

-   $Mi(a)$ is the mediator achieved for person i if, possibly contrary
    to fact, exposure had been set to a.

One can combine the two counterfactuals, yielding so-called nested
counterfactuals defined as

-   $Y(a, M (a\*)$.

By introducing the nested counterfactual for a ≠ a\* we can give a
precise mathematical definition of mediation.
:::

Once you have grasped the core builds on comparing distributions of
nested counterfactuals, these effects can just as easily be expressed on
other scales than the averages.

The Cox proportional hazards model is commonly used for dealing with
survival data in medical literature and can explain multiplicative
effects under the different effect scale in mediation analysis \[20,
21\]. Cox regression estimates the **hazard ratios** and the values were
then used to determine the effect of the mediator variable between the
exposure and the survival time of outcome.

For a **survival outcome**, the outcome of interest will be survival
time (SV).

-   SV (t) = P(V ≥ t) the survival function at time t

-   SV (t\|c)=P(V ≥ t\|c) the survival function conditional on
    covariates C

-   λV (t) : the hazard

-   λV (t\|c): conditional hazard at time

## Assumptions of mediation analysis with a time-to-event outcome

Similar as our context, mediation analysis with a time-to-event outcome
have to satisfy below assumptions: - no unmeasured confounding of the
exposure-outcome relation;

-   no unmeasured confounding of the mediator-outcome relation;

-   no unmeasured confounding of the exposure-mediation relation;

-   no exposure induced mediation-outcome confounding

## Conduct mediation analysis with a time-to-event outcome

So far, the survial mediation analyses was developed on a regression
model. In particular, a NEM is a regression model for the nested
counterfactual. Expressed as a generalized linear model (GLM), it
becomes:

$g(E[Y (a, M (a*))]) = α0 + α1a + α2a*$

If, for instance, g is the logit function, then α1 would be the marginal
natural direct effect log-OR.

Estimation algorithms for NEMs are all derived under the assumptions
listed in the preceding section, and build on the trick that first we
duplicate the original data set, then we create an artificial exposure,
A*, which takes on different values in the 2 replications of each
observation. Finally, we use an auxiliary model to link the artificial
observations (i.e., those where A ≠ A*) to the mediators, which is
either done through weighting or through imputation. Once this is done,
the NEM can be estimated by simply applying standard software applied to
the extended data set and using both A and A\*, possibly along with C,
as the model specification. This entire procedure has been automated and
implemented in the R package medflex for any GLM type outcome model. In
the following, we describe in detail how to estimate a NEM for a
survival outcome with a multidimensional mediator. This is the situation
we have in the illustrative case.

::: callout-note
## Could we use the traditional approach for time-to-event outcomes?

So how to conduct causal mediation analysis for time-to-event outcomes?
We introduced the difference and product methods for continuous and
binary outcomes in previous session, also discuss the caveats of these
approaches. It is still true these methods are ill-adapted to
non-normally distributed continuous and/or censored variables, such as
time-to-event outcomes \[Lois\]. Similar as odds ratio,
''non-collaspsibility'' is a problem of the hazard ratio. (VanderWeele)
Thus, use of Cox PH regression to approximately estimate indirect
effects via difference or product of coefficients rests on the
assumption that the outcome is rare \[21\]. Where the outcome is common,
measures of the indirect effect or proportion mediated will be incorrect
\[arvid\].

To sum up, we could still use these approaches if certain criterias are
fulfilled. Otherwise, we can use the product method to get a sense of
whether there is mediation, but be aware that the estimate is not
accurate.
:::

## Coding example

::: callout-note
We will continue working on the obesity-CVD example in the Framingham
dataset. The outcome of interest is death from cardiovascular diseases
(cvd). The underlying time scale is in days, starting at participants
entered the cohort. - The exposure of interest is obesity status at
baseline, where a=1 indicates obese, a=0 indicates non-obese.

-The mediator is blood pressure, the counterfactual mediator was M(a),
where M(a) is the mediator when the exposure is obesity (1) and M(0) is
the mediator values when the exposure is not-obese.

-The nested counterfactual was death time. For ease of exposition, we
will only refer to the underlying event time and event indicator when
required by context.
:::

The question of interest here is whether the blood pressure mediates the
impact of obesity on CVD-related death (measured in years).

-   survival analysis
-   code-along with package and setup of survival data

# Coding part - Daniel

::: callout-note
## Learning outcomes

-   Perform causal mediation analysis using R software
-   Interpret results from causal mediation analysis
:::

-   survival analysis
-   code-along with package and setup of survival data

<!-- Coding part - Daniel -->

```{r}
library(tidyverse)
framingham <- read.csv(here::here("data", "frmgham2.csv"))

framingham <- framingham %>%
  select(
    id = RANDID,
    BMI,
    m = SYSBP,
    y = CVD,
    w1 = SEX,
    w2 = CURSMOKE,
    w3 = AGE,
    y_time = TIMECVD
  ) %>%
  na.omit() %>%
  mutate(
    a = case_when(
      BMI >= 25 ~ 1,
      TRUE ~ 0
    ),
    y_time = y_time / 365.25
  ) %>%
  select(-BMI)
```

> Does obesity lead to higher CVD risk by increasing blood pressure?

The new thing here is that we need to calculate the time to event. This
is already done in the dataset.

We need the outcome to be the time to event and specify event as the
outcome variable.

```{r}
library(CMAverse)
library(survival)

res_rb_coxph <- cmest(
  data = framingham, model = "rb", outcome = "y_time", event = "y", exposure = "a",
  mediator = "m", basec = c("w1", "w2", "w3"), EMint = TRUE,
  mreg = list("linear"), yreg = "coxph",
  astar = 0, a = 1, mval = list(120),
  estimation = "imputation", inference = "bootstrap"
)


summary(res_rb_coxph)
```
